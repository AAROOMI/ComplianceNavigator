<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>Metaworks Cybersecurity Compliance Platform</title>
    <meta name="description" content="NCA ECC V1 & V2 Compliance Management with AI-powered assistance" />
    <script
      type="module"
      src="https://agent.d-id.com/v1/index.js"
      data-name="did-agent"
      data-mode="fabio"
      data-client-key="YXV0aDB8NjdlZWI3NmYwOTYxZDU0Yjg2N2Y4ZWE3OkMwcExqeHpDYkl0VWt0N1dBQ056WQ=="
      data-agent-id="agt_56bnv71C"
      data-monitor="true"
      onload="console.log('‚úÖ D-ID Agent script loaded successfully'); window.didAgentLoaded = true; window.didAgentFailed = false;"
      onerror="console.log('‚ùå D-ID Agent script failed to load - will use fallback'); window.didAgentFailed = true; window.didAgentLoaded = false;">
    </script>
    <script>
      // Global error handlers for all D-ID related failures
      let didServiceFailed = false;
      
      window.addEventListener('unhandledrejection', function(event) {
        if (event.reason && (event.reason.message || '').toLowerCase().includes('d-id')) {
          console.warn('‚ö†Ô∏è D-ID promise rejection:', event.reason.message || event.reason);
          event.preventDefault();
          didServiceFailed = true;
        }
      });
      
      // Monitor D-ID service status (for logging only)
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const promise = originalFetch.apply(this, args);
        
        return promise.catch(error => {
          const url = args[0] || '';
          if (url.toString().toLowerCase().includes('d-id.com')) {
            console.warn('üö® D-ID service network error:', error.message);
          }
          throw error;
        }).then(response => {
          const url = args[0] || '';
          if (url.toString().toLowerCase().includes('d-id.com') && response && (response.status === 429 || response.status >= 400)) {
            console.warn(`üö® D-ID service error: ${response.status} ${response.statusText}`);
          }
          return response;
        });
      };
      
      // Enhanced D-ID agent initialization and debugging
      document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM loaded, initializing D-ID integration...');
        
        // Initialize D-ID status tracking
        window.didAgentStatus = 'loading';
        
        // Wait for D-ID agent to fully initialize
        setTimeout(() => {
          console.log('üîç Checking D-ID agent status after initialization period...');
          
          // Check if D-ID script failed to load
          if (window.didAgentFailed) {
            console.log('‚ùå D-ID script failed to load');
            window.didAgentStatus = 'failed';
            return;
          }
          
          // Check if D-ID agent is available
          const didProperties = Object.keys(window).filter(k => k.toLowerCase().includes('did'));
          console.log('üîé D-ID related window properties:', didProperties);
          
          // Check for D-ID API availability
          if (typeof window.DID_AGENTS_API !== 'undefined') {
            console.log('‚úÖ D-ID API detected');
            window.didAgentStatus = 'ready';
          } else {
            console.log('‚ö†Ô∏è D-ID API not detected - connection may have failed');
            window.didAgentStatus = 'failed';
            window.didAgentFailed = true;
          }
          
          // Check for D-ID elements in DOM
          const didElements = document.querySelectorAll('*[class*="did"], *[id*="did"], *[data-testid*="did"]');
          console.log('üîé D-ID DOM elements found:', didElements.length);
          
          // Check for iframes (D-ID agent might load in iframe)
          const iframes = document.querySelectorAll('iframe');
          console.log('üîé Iframes found:', iframes.length);
        }, 3000);
        
        // Global function to launch D-ID agent for voice conversation
        window.openDIDAgent = function() {
          console.log('üé§ Sarah Johnson clicked - launching D-ID voice agent...');
          
          let didOpened = false;
          
          // Try to launch D-ID agent using available API methods
          if (typeof window.DID_AGENTS_API !== 'undefined') {
            try {
              console.log('üé¨ Launching D-ID voice agent...');
              
              // Primary method: show D-ID agent interface
              if (window.DID_AGENTS_API.show) {
                window.DID_AGENTS_API.show();
                console.log('‚úÖ D-ID Voice Agent launched successfully!');
                return true;
              }
              
              // Alternative methods
              if (window.DID_AGENTS_API.open) {
                window.DID_AGENTS_API.open();
                console.log('‚úÖ D-ID Agent opened successfully!');
                return true;
              }
              
              if (window.DID_AGENTS_API.start) {
                window.DID_AGENTS_API.start();
                console.log('‚úÖ D-ID Agent started successfully!');
                return true;
              }
              
              if (window.DID_AGENTS_API.toggle) {
                window.DID_AGENTS_API.toggle();
                console.log('‚úÖ D-ID Agent toggled successfully!');
                return true;
              }
              
            } catch (error) {
              console.error('‚ùå Error launching D-ID agent:', error);
              alert('Error launching D-ID voice agent: ' + error.message);
              return false;
            }
          }
          
          // Method 2: Look for D-ID elements and try to activate them
          const didElements = document.querySelectorAll('[data-testid*="did"], [class*="did"], [id*="did"]');
          
          if (didElements.length > 0 && !didOpened) {
            console.log('üîç Found D-ID elements, attempting to activate...');
            
            for (let element of didElements) {
              try {
                if (element.click) {
                  element.click();
                  console.log('‚úÖ D-ID element activated!');
                  didOpened = true;
                  return true;
                }
              } catch (error) {
                console.warn('‚ö†Ô∏è Element activation failed:', error.message);
              }
            }
          }
          
          // If no D-ID API available, show message
          if (!didOpened) {
            console.warn('‚ùå D-ID Voice Agent not available');
            alert('D-ID Voice Agent is not available at the moment. Please try again later.');
            return false;
          }
          
          return didOpened;
        };
        
        // Make fallback chat available globally for auto-triggering
        window.showFallbackChatDirect = function() {
          showFallbackChat();
        };
        
        // Fallback chat interface for Sarah Johnson
        function showFallbackChat() {
          console.log('üéØ Opening Sarah Johnson chat interface...');
          
          // Remove existing chat if present
          const existingChat = document.getElementById('sarah-chat-widget');
          if (existingChat) {
            console.log('üóëÔ∏è Removing existing chat widget');
            existingChat.remove();
          }
          
          // Mark that we've opened the fallback
          didServiceFailed = true;
          
          // Create chat widget
          const chatWidget = document.createElement('div');
          chatWidget.id = 'sarah-chat-widget';
          chatWidget.innerHTML = `
            <div style="
              position: fixed;
              bottom: 20px;
              right: 20px;
              width: 350px;
              height: 500px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border-radius: 15px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              z-index: 10000;
              display: flex;
              flex-direction: column;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            ">
              <!-- Header -->
              <div style="
                background: rgba(255,255,255,0.1);
                padding: 15px;
                border-radius: 15px 15px 0 0;
                display: flex;
                align-items: center;
                justify-content: space-between;
                backdrop-filter: blur(10px);
              ">
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="
                    width: 40px;
                    height: 40px;
                    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><circle cx="12" cy="8" r="3"/><path d="M12 14c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/></svg>') center/cover;
                    border-radius: 50%;
                    border: 2px solid rgba(255,255,255,0.3);
                  "></div>
                  <div>
                    <div style="color: white; font-weight: 600; font-size: 16px;">Sarah Johnson</div>
                    <div style="color: rgba(255,255,255,0.8); font-size: 12px;">CEO ‚Ä¢ Cybersecurity Expert</div>
                  </div>
                </div>
                <button onclick="document.getElementById('sarah-chat-widget').remove()" style="
                  background: none;
                  border: none;
                  color: white;
                  font-size: 20px;
                  cursor: pointer;
                  padding: 5px;
                  border-radius: 5px;
                  opacity: 0.7;
                " onmouseover="this.style.opacity='1'; this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.opacity='0.7'; this.style.background='none'">√ó</button>
              </div>
              
              <!-- Chat Messages -->
              <div id="sarah-chat-messages" style="
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                background: rgba(255,255,255,0.05);
              ">
                <div style="
                  background: rgba(255,255,255,0.9);
                  padding: 12px 16px;
                  border-radius: 15px 15px 15px 5px;
                  margin-bottom: 15px;
                  color: #333;
                  font-size: 14px;
                  line-height: 1.4;
                ">
                  <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">Sarah Johnson</div>
                  üëã Hello! I'm Sarah Johnson, CEO of ComplianceNavigator. I'm here to help you with cybersecurity compliance, risk assessments, and NCA ECC implementation.
                </div>
                <div style="
                  background: rgba(255,255,255,0.9);
                  padding: 12px 16px;
                  border-radius: 15px 15px 15px 5px;
                  margin-bottom: 15px;
                  color: #333;
                  font-size: 14px;
                  line-height: 1.4;
                ">
                  <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">Sarah Johnson</div>
                  What can I help you with today? You can ask me about:
                  <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                    <li>Risk assessment strategies</li>
                    <li>NCA ECC compliance requirements</li>
                    <li>Implementation best practices</li>
                    <li>Security policy development</li>
                  </ul>
                </div>
              </div>
              
              <!-- Input -->
              <div style="
                padding: 15px;
                background: rgba(255,255,255,0.1);
                border-radius: 0 0 15px 15px;
                backdrop-filter: blur(10px);
              ">
                <div style="display: flex; gap: 10px;">
                  <input 
                    id="sarah-chat-input" 
                    type="text" 
                    placeholder="Ask Sarah about cybersecurity..." 
                    style="
                      flex: 1;
                      padding: 10px 15px;
                      border: none;
                      border-radius: 25px;
                      background: rgba(255,255,255,0.9);
                      outline: none;
                      font-size: 14px;
                    "
                    onkeypress="if(event.key==='Enter') sendSarahMessage()"
                  >
                  <button 
                    onclick="sendSarahMessage()" 
                    style="
                      background: linear-gradient(45deg, #667eea, #764ba2);
                      border: none;
                      color: white;
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      cursor: pointer;
                      font-size: 16px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                    "
                    onmouseover="this.style.transform='scale(1.1)'" 
                    onmouseout="this.style.transform='scale(1)'"
                  >‚Üí</button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(chatWidget);
          
          // Focus input
          setTimeout(() => {
            const input = document.getElementById('sarah-chat-input');
            if (input) input.focus();
          }, 100);
          
          console.log('‚úÖ Sarah Johnson chat is now ready!');
          
          // Add a subtle animation
          setTimeout(() => {
            chatWidget.style.transform = 'scale(1.02)';
            setTimeout(() => {
              chatWidget.style.transform = 'scale(1)';
              chatWidget.style.transition = 'transform 0.2s ease';
            }, 150);
          }, 100);
        }
        
        // Handle chat messages
        window.sendSarahMessage = function() {
          const input = document.getElementById('sarah-chat-input');
          const messages = document.getElementById('sarah-chat-messages');
          
          if (!input || !messages || !input.value.trim()) return;
          
          const userMessage = input.value.trim();
          input.value = '';
          
          // Add user message
          const userDiv = document.createElement('div');
          userDiv.style.cssText = `
            background: linear-gradient(45deg, #667eea, #764ba2);
            padding: 12px 16px;
            border-radius: 15px 15px 5px 15px;
            margin: 15px 0;
            margin-left: 50px;
            color: white;
            font-size: 14px;
            line-height: 1.4;
          `;
          userDiv.innerHTML = `<div style="font-weight: 600; margin-bottom: 5px; opacity: 0.8;">You</div>${userMessage}`;
          messages.appendChild(userDiv);
          
          // Simulate Sarah's response
          setTimeout(() => {
            const responses = [
              "That's a great question about cybersecurity compliance. Based on the NCA ECC framework, I recommend starting with a comprehensive risk assessment to identify your current security posture.",
              "For NCA ECC implementation, focus on the five core domains: Governance, Cybersecurity Defence, Cybersecurity Resilience, Third Party Cloud Computing, and Industrial Control Systems.",
              "Risk management is crucial for compliance. I suggest using our NFRM Risk Management tool to conduct thorough assessments and generate detailed reports.",
              "Security policies should align with your organizational structure. Our AI-powered policy generator can help you create customized policies based on NCA ECC requirements.",
              "Gap assessments are essential for identifying compliance gaps. Use our ECC Implementation Dashboard to track your progress across all 114 essential controls.",
              "Remember that cybersecurity compliance is an ongoing process. Regular assessments, continuous monitoring, and staff training are key components of a successful program."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const sarahDiv = document.createElement('div');
            sarahDiv.style.cssText = `
              background: rgba(255,255,255,0.9);
              padding: 12px 16px;
              border-radius: 15px 15px 15px 5px;
              margin: 15px 0;
              color: #333;
              font-size: 14px;
              line-height: 1.4;
            `;
            sarahDiv.innerHTML = `<div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">Sarah Johnson</div>${randomResponse}`;
            messages.appendChild(sarahDiv);
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
          }, 1000);
          
          // Scroll to bottom
          messages.scrollTop = messages.scrollHeight;
        };
      });
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>